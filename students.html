<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="./icon.png">
  <title>Student Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body class="p-4">

  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 px-3">

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Push to right -->
      <ul class="navbar-nav ms-auto">

        <!-- Profile Dropdown -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center"
            href="#"
            id="profileDropdown"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false">

            <img src="image.png" alt="Profile" width="40" height="40" class="rounded-circle border me-2" />

            Profile
          </a>

          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="/profile.html">Profile Update</a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="#" id="logout">Logout</a>
            </li>
          </ul>
        </li>

      </ul>
    </div>
  </nav>

  <div class="container">
    <div id="successAlert" class="alert alert-success d-none" role="alert"></div>
    <h2 class="mb-4">Student Records</h2>

    <!-- SEARCH + ACTION BUTTONS (FIXED RESPONSIVE) -->
    <div class="row mb-3 align-items-center g-3">

      <!-- Search box -->
      <div class="col-12 col-md-5">
        <div class="input-group">
          <span class="input-group-text">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16">
              <path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z"/>
            </svg>
          </span>
          <input type="text" id="searchInput" class="form-control" placeholder="Search by name">
        </div>
      </div>

      <!-- Buttons -->
      <div class="col-12 col-md-7 d-flex justify-content-md-end justify-content-start gap-3 flex-wrap">

        <div style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#paymentModal">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">
            <path fill="#f50f0f" d="M160 128C160 110.3 174.3 96 192 96L456 96C469.3 96 480 106.7 480 120C480 133.3 469.3 144 456 144L379.3 144C397 163.8 409.4 188.6 414 216L456 216C469.3 216 480 226.7 480 240C480 253.3 469.3 264 456 264L414 264C403.6 326.2 353.2 374.9 290.2 382.9L434.6 486C449 496.3 452.3 516.3 442 530.6C431.7 544.9 411.7 548.3 397.4 538L173.4 378C162.1 370 157.3 355.5 161.5 342.2C165.7 328.9 178.1 320 192 320L272 320C307.8 320 338.1 296.5 348.3 264L184 264C170.7 264 160 253.3 160 240C160 226.7 170.7 216 184 216L348.3 216C338.1 183.5 307.8 160 272 160L192 160C174.3 160 160 145.7 160 128z"/>
          </svg>
        </div>

        <div style="cursor:pointer;" onclick="downloadExcel()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">
            <path fill="#2cce9d" d="M128 128C128 92.7 156.7 64 192 64L341.5 64C358.5 64 374.8 70.7 386.8 82.7L493.3 189.3C505.3 201.3 512 217.6 512 234.6L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 128z"/>
          </svg>
        </div>

        <div data-bs-toggle="modal" data-bs-target="#sendMailModal" style="cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">
            <path fill="#0d09dc" d="M125.4 128C91.5 128 64 155.5 64 189.4L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 189.4C576 155.5 548.5 128 514.6 128L125.4 128z"/>
          </svg>
        </div>

        <div data-bs-toggle="modal" data-bs-target="#addStudentModal" style="cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">
            <path fill="#22d61f" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576z"/>
          </svg>
        </div>

        <div onclick="fetchStudents()" style="cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">
            <path fill="#74C0FC" d="M129.9 292.5C143.2 199.5 223.3 128 320 128"/>
          </svg>
        </div>

      </div>
    </div>

    <!-- TABLE -->
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Profile</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Gender</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentTableBody"></tbody>
    </table>

    <nav>
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
  </div>


  <!-- View Student Modal -->
<div class="modal fade" id="viewStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- <img id="viewProfilePic" src="" class="rounded mb-3" width="100" /> -->
        <img 
              id="viewProfilePic"
              src="" 
              width="100" 
              height="100" 
              class="rounded mb-3"
              onerror="this.src='https://placehold.co/100'"
            />
        <p><strong>Name:</strong> <span id="viewName"></span></p>
        <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Phone:</strong> <span id="viewPhone"></span></p>
        <p><strong>Gender:</strong> <span id="viewGender"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addStudentForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Add New Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <input type="text" class="form-control" name="first_name" placeholder="First Name" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" name="last_name" placeholder="Last Name" required>
          </div>
          <div class="mb-2">
            <input type="email" class="form-control" name="email" placeholder="Email" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" name="phone" placeholder="Phone" required>
          </div>
          <div class="mb-2">
            <select class="form-select" name="gender" required>
              <option value="">Select Gender</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Upload Profile Picture:</label>
            <input type="file" class="form-control" name="profile_pic">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Create Student</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editStudentForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Edit Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editStudentId">
            <div class="mb-2">
              <input type="text" class="form-control" id="editFirstName" name="first_name" placeholder="First Name" required>
            </div>
            <div class="mb-2">
              <input type="text" class="form-control" id="editLastName" name="last_name" placeholder="Last Name" required>
            </div>
            <div class="mb-2">
              <input type="email" class="form-control" id="editEmail" name="email" placeholder="Email" required>
            </div>
            <div class="mb-2">
              <input type="text" class="form-control" id="editPhone" name="phone" placeholder="Phone" required>
            </div>
            <div class="mb-2">
              <select class="form-select" id="editGender" name="gender" required>
                <option value="">Select Gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-2">
              <label>Upload New Profile Picture:</label>
              <input type="file" class="form-control" id="editProfilePic" name="profile_pic">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Send Mail Modal -->
  <div class="modal fade" id="sendMailModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="sendMailForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Send Email</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label fw-semibold">Recipient Email</label>
              <input type="email" class="form-control" name="to" placeholder="example@gmail.com" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Subject</label>
              <input type="text" class="form-control" name="subject" placeholder="Enter email subject" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Message</label>
              <textarea class="form-control" name="text" rows="4" placeholder="Write your message here..." required></textarea>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold">Attachment</label>
              <input type="file" class="form-control" name="file">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Send Email</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="paymentForm">
          <div class="modal-header">
            <h5 class="modal-title">Make a Payment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label fw-semibold">Amount</label>
              <input type="number" class="form-control" id="paymentAmount" placeholder="Enter amount" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Message</label>
              <textarea class="form-control" id="paymentMessage" rows="4" placeholder="Enter a message"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Pay Now</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
  <script>
    const BASE_URL = 'https://student-management-lilac-seven.vercel.app';
    const apiUrl = `${BASE_URL}/api/students`;
    const usersApiUrl = `${BASE_URL}/api/users`;
    let currentPage = 1
    let currentSearch = ''

    function generatePdf(id) {
      window.open(`student-pdf-generation.html?id=${id}`, '_blank');
    }

    function checkAuth() {
      const token = localStorage.getItem("token")
      if (!token) {
        alert("You must be logged in to view this page")
        window.location.href = "index.html"
      }
      return token
    }

    const token = checkAuth()

    // View All Students
    async function fetchStudents(search = '', page = 1) {
      currentPage = page
      currentSearch = search

      const res = await fetch(
        `${apiUrl}?search=${encodeURIComponent(search)}&page=${page}&limit=3`, {
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        }
      )
      const data = await res.json()
      // console.log(data)

      const tbody = document.querySelector('#studentTableBody')
      tbody.innerHTML = ''

      data.students.forEach(student => {
        tbody.innerHTML += `
        <tr class="text-center align-middle">
          <td>
            <img 
              src="${student.profile_pic}" 
              width="50" 
              height="50" 
              class="rounded-circle"
            />
          </td>
          <td>${student.first_name}</td>
          <td>${student.last_name}</td>
          <td>${student.email}</td>
          <td>${student.phone}</td>
          <td>${student.gender}</td>
          <td>
            <div class="d-flex gap-3">
              <div onclick="viewStudent('${student._id}')" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#74C0FC" d="M73 39.1C63.6 29.7 48.4 29.7 39.1 39.1C29.8 48.5 29.7 63.7 39 73.1L567 601.1C576.4 610.5 591.6 610.5 600.9 601.1C610.2 591.7 610.3 576.5 600.9 567.2L504.5 470.8C507.2 468.4 509.9 466 512.5 463.6C559.3 420.1 590.6 368.2 605.5 332.5C608.8 324.6 608.8 315.8 605.5 307.9C590.6 272.2 559.3 220.2 512.5 176.8C465.4 133.1 400.7 96.2 319.9 96.2C263.1 96.2 214.3 114.4 173.9 140.4L73 39.1zM208.9 175.1C241 156.2 278.1 144 320 144C385.2 144 438.8 173.6 479.9 211.7C518.4 247.4 545 290 558.5 320C544.9 350 518.3 392.5 479.9 428.3C476.8 431.1 473.7 433.9 470.5 436.7L425.8 392C439.8 371.5 448 346.7 448 320C448 249.3 390.7 192 320 192C293.3 192 268.5 200.2 248 214.2L208.9 175.1zM390.9 357.1L282.9 249.1C294 243.3 306.6 240 320 240C364.2 240 400 275.8 400 320C400 333.4 396.7 346 390.9 357.1zM135.4 237.2L101.4 203.2C68.8 240 46.4 279 34.5 307.7C31.2 315.6 31.2 324.4 34.5 332.3C49.4 368 80.7 420 127.5 463.4C174.6 507.1 239.3 544 320.1 544C357.4 544 391.3 536.1 421.6 523.4L384.2 486C364.2 492.4 342.8 496 320 496C254.8 496 201.2 466.4 160.1 428.3C121.6 392.6 95 350 81.5 320C91.9 296.9 110.1 266.4 135.5 237.2z"/></svg>
              </div>
              <div onclick="editStudent('${student._id}')" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#FFD43B" d="M505 122.9L517.1 135C526.5 144.4 526.5 159.6 517.1 168.9L488 198.1L441.9 152L471 122.9C480.4 113.5 495.6 113.5 504.9 122.9zM273.8 320.2L408 185.9L454.1 232L319.8 366.2C316.9 369.1 313.3 371.2 309.4 372.3L250.9 389L267.6 330.5C268.7 326.6 270.8 323 273.7 320.1zM437.1 89L239.8 286.2C231.1 294.9 224.8 305.6 221.5 317.3L192.9 417.3C190.5 425.7 192.8 434.7 199 440.9C205.2 447.1 214.2 449.4 222.6 447L322.6 418.4C334.4 415 345.1 408.7 353.7 400.1L551 202.9C579.1 174.8 579.1 129.2 551 101.1L538.9 89C510.8 60.9 465.2 60.9 437.1 89zM152 128C103.4 128 64 167.4 64 216L64 488C64 536.6 103.4 576 152 576L424 576C472.6 576 512 536.6 512 488L512 376C512 362.7 501.3 352 488 352C474.7 352 464 362.7 464 376L464 488C464 510.1 446.1 528 424 528L152 528C129.9 528 112 510.1 112 488L112 216C112 193.9 129.9 176 152 176L264 176C277.3 176 288 165.3 288 152C288 138.7 277.3 128 264 128L152 128z"/></svg>
              </div>
              <div onclick="generatePdf('${student._id}')" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#B197FC" d="M240 112L128 112C119.2 112 112 119.2 112 128L112 512C112 520.8 119.2 528 128 528L208 528L208 576L128 576C92.7 576 64 547.3 64 512L64 128C64 92.7 92.7 64 128 64L261.5 64C278.5 64 294.8 70.7 306.8 82.7L429.3 205.3C441.3 217.3 448 233.6 448 250.6L448 400.1L400 400.1L400 272.1L312 272.1C272.2 272.1 240 239.9 240 200.1L240 112.1zM380.1 224L288 131.9L288 200C288 213.3 298.7 224 312 224L380.1 224zM272 444L304 444C337.1 444 364 470.9 364 504C364 537.1 337.1 564 304 564L292 564L292 592C292 603 283 612 272 612C261 612 252 603 252 592L252 464C252 453 261 444 272 444zM304 524C315 524 324 515 324 504C324 493 315 484 304 484L292 484L292 524L304 524zM400 444L432 444C460.7 444 484 467.3 484 496L484 560C484 588.7 460.7 612 432 612L400 612C389 612 380 603 380 592L380 464C380 453 389 444 400 444zM432 572C438.6 572 444 566.6 444 560L444 496C444 489.4 438.6 484 432 484L420 484L420 572L432 572zM508 464C508 453 517 444 528 444L576 444C587 444 596 453 596 464C596 475 587 484 576 484L548 484L548 508L576 508C587 508 596 517 596 528C596 539 587 548 576 548L548 548L548 592C548 603 539 612 528 612C517 612 508 603 508 592L508 464z"/></svg>
              </div>
              <div onclick="deleteStudent('${student._id}')" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#f63404" d="M262.2 48C248.9 48 236.9 56.3 232.2 68.8L216 112L120 112C106.7 112 96 122.7 96 136C96 149.3 106.7 160 120 160L520 160C533.3 160 544 149.3 544 136C544 122.7 533.3 112 520 112L424 112L407.8 68.8C403.1 56.3 391.2 48 377.8 48L262.2 48zM128 208L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 208L464 208L464 512C464 520.8 456.8 528 448 528L192 528C183.2 528 176 520.8 176 512L176 208L128 208zM288 280C288 266.7 277.3 256 264 256C250.7 256 240 266.7 240 280L240 456C240 469.3 250.7 480 264 480C277.3 480 288 469.3 288 456L288 280zM400 280C400 266.7 389.3 256 376 256C362.7 256 352 266.7 352 280L352 456C352 469.3 362.7 480 376 480C389.3 480 400 469.3 400 456L400 280z"/></svg>
              </div>
            </div>
          </td>
        </tr>
      `
      });

      renderPagination(data.totalPage)
    }

    fetchStudents() // Call fetchStudents() when page load first time

    // Pagination Function
    function renderPagination(totalPages) {
      const container = document.querySelector("#pagination")
      container.innerHTML = ''

      // Previous Button
      const prevli = document.createElement('li')
      prevli.className = 'page-item' + (currentPage === 1 ? ' disabled' : '')
      prevli.innerHTML = `<a class="page-link" href="#">Previous</a>`
      prevli.addEventListener("click", (e) => {
        e.preventDefault()
        fetchStudents(currentSearch, currentPage - 1)
      })
      container.appendChild(prevli)

      // Numbered Pagination
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li')
        li.className = 'page-item' + (i === currentPage ? ' active' : '')
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`
        li.addEventListener("click", (e) => {
          e.preventDefault()
          fetchStudents(currentSearch, i)
        })
        container.appendChild(li)
      }

      // Next Button
      const nextli = document.createElement('li')
      nextli.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '')
      nextli.innerHTML = `<a class="page-link" href="#">Next</a>`
      nextli.addEventListener("click", (e) => {
        e.preventDefault()
        fetchStudents(currentSearch, currentPage + 1)
      })
      container.appendChild(nextli)
    }

    // View Single Student Record
    async function viewStudent(id) {
      const res = await fetch(
        `${apiUrl}/${id}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        }
      )
      const student = await res.json()
      // console.log(data)

      // document.querySelector("#viewProfilePic").src = `${BASE_URL}/uploads/${student.profile_pic}`
      document.querySelector("#viewProfilePic").src = student.profile_pic || 'https://placehold.co/100'
      document.querySelector("#viewName").textContent = `${student.first_name} ${student.last_name}`
      document.querySelector("#viewEmail").textContent = student.email
      document.querySelector("#viewPhone").textContent = student.phone
      document.querySelector("#viewGender").textContent = student.gender

      new bootstrap.Modal(document.querySelector("#viewStudentModal")).show()
    }

    // Search Student
    document.querySelector("#searchInput").addEventListener("input", () => {
      currentPage = 1
      fetchStudents(document.querySelector("#searchInput").value, currentPage)
    })

    // Add New Student 
    document.querySelector("#addStudentForm").addEventListener("submit", async function(e) {
      e.preventDefault()

      const formData = new FormData(this)

      const res = await fetch(apiUrl, {
        method: 'POST',
        body: formData,
        headers: {
          "Authorization": `Bearer ${token}`,
        }
      })

      if (res.ok) {
        this.reset()
        bootstrap.Modal.getInstance(document.querySelector("#addStudentModal")).hide()
        fetchStudents()
      } else {
        alert('Error creating student.')
      }
    })

    // Delete Student
    async function deleteStudent(id) {
      if (confirm("Are you sure to delete this student ?")) {
        await fetch(
          `${apiUrl}/${id}`, {
            method: 'DELETE',
            headers: {
              "Authorization": `Bearer ${token}`,
            },
          }
        )
        fetchStudents()
      }
    }

    // Update Student Modal Box
    async function editStudent(id) {

      const res = await fetch(
        `${apiUrl}/${id}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        }
      )
      const student = await res.json()

      document.querySelector('#editStudentId').value = student._id
      document.querySelector('#editFirstName').value = student.first_name
      document.querySelector('#editLastName').value = student.last_name
      document.querySelector('#editEmail').value = student.email
      document.querySelector('#editPhone').value = student.phone
      document.querySelector('#editGender').value = student.gender

      new bootstrap.Modal(document.querySelector("#editStudentModal")).show()
    }

    // Update Student Record
    document.querySelector("#editStudentForm").addEventListener("submit", async function(e) {
      e.preventDefault()

      const id = document.querySelector("#editStudentId").value

      const formData = new FormData(this)

      const res = await fetch(
        `${apiUrl}/${id}`, {
          method: 'PUT',
          body: formData,
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        }
      )

      if (res.ok) {
        bootstrap.Modal.getInstance(document.querySelector("#editStudentModal")).hide()
        fetchStudents()
      } else {
        alert('Error updating student.')
      }
    })


    async function downloadExcel() {
      const res = await fetch(`${apiUrl}/download/excel`, {
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      });

      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'students.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      } else {
        alert('Error downloading Excel file.');
      }
    }

    // Logout Function
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem("token")
      window.location.href = "index.html"
    })

    // Send Mail
    document.querySelector("#sendMailForm").addEventListener("submit", async function(e) {
      e.preventDefault()

      const formData = new FormData(this)
      const actionUrl = `${usersApiUrl}/send-email`;

      try {
        const res = await fetch(actionUrl, {
          method: 'POST',
          body: formData,
          headers: {
            "Authorization": `Bearer ${token}`,
          }
        });

        if (res.ok) {
          this.reset();
          bootstrap.Modal.getInstance(document.querySelector("#sendMailModal")).hide();
          alert('Email sent successfully!');
        } else {
          const errorData = await res.json();
          alert(`Failed to send email: ${errorData.message} - Details: ${errorData.error}`);
        }
      } catch (error) {
        console.error('Error sending email:', error);
        alert('An error occurred while sending the email.');
      }
    });

    // Payment Gateway
    document.querySelector("#paymentForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const amount = document.getElementById("paymentAmount").value;
      const message = document.getElementById("paymentMessage").value;
      const token = localStorage.getItem("token");

      if (!amount) {
        alert("Please enter an amount.");
        return;
      }

      const options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          amount
        }),
      };

      try {
        const res = await fetch(`${BASE_URL}/api/payment/create-order`, options);
        const order = await res.json();

        if (res.ok) {
          const razorpayOptions = {
            key: order.key,
            amount: order.amount,
            currency: order.currency,
            name: "Student Management",
            description: message,
            order_id: order.id,
            handler: function(response) {
              verifyPayment(response);
            },
            prefill: {
              name: "Your Name",
              email: "your.email@example.com",
              contact: "9999999999",
            },
            notes: {
              address: "Razorpay Corporate Office",
            },
            theme: {
              color: "#3399cc",
            },
          };

          const rzp1 = new Razorpay(razorpayOptions);

          rzp1.on("payment.failed", function(response) {
            window.location.href = "payment-failed.html";
          });

          rzp1.open();
        } else {
          alert("Failed to create order. Please try again.");
        }
      } catch (error) {
        console.error("Error creating payment order:", error);
        alert("An error occurred while creating the payment order.");
      }
    });

    async function verifyPayment(response) {
      const token = localStorage.getItem("token");
      const options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(response),
      };

      try {
        const res = await fetch(`${BASE_URL}/api/payment/verify-payment`, options);
        const data = await res.json();

        if (res.ok && data.status === 'ok') {
          window.location.href = "payment-success.html";
        } else {
          window.location.href = "payment-failed.html";
        }
      } catch (error) {
        console.error("Error verifying payment:", error);
        window.location.href = "payment-failed.html";
      }
    }
  </script>
</body>

</html>
